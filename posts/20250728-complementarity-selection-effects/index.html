<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Angelos Amyntas">
<meta name="dcterms.date" content="2025-07-28">
<meta name="description" content="…or more precisely, the Loreau &amp; Hector partitioning.">

<title>Explaining to myself selection &amp; complementarity effects</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-7e58e3368124f49f6e3733161a9b089d.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-ca57a4f376f1bf75f538be918031b930.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">about me</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications.html"> 
<span class="menu-text">publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../cv.html"> 
<span class="menu-text">cv</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../contact.html"> 
<span class="menu-text">contact</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">posts</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools tools-wide">
    <a href="https://github.com/amynang" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
    <a href="https://ecoevo.social/@amyntas" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-mastodon"></i></a>
    <a href="https://bsky.app/profile/amyntas.bsky.social" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-bluesky"></i></a>
    <a href="https://bsky.app/profile/amyntas.bsky.social" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-twitter"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Explaining to myself selection &amp; complementarity effects</h1>
                  <div>
        <div class="description">
          …or more precisely, the Loreau &amp; Hector partitioning.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">complementarity</div>
                <div class="quarto-category">selection</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Angelos Amyntas </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 28, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div class="callout callout-style-default callout-caution callout-titled" title="warning">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is a draft. There are probably more errors and nonsense than usual.</p>
</div>
</div>
<section id="motivation" class="level2">
<h2 class="anchored" data-anchor-id="motivation">motivation</h2>
<p>Descriptions of Loreau and Hector’s (2001) partitioning of <strong>net biodiversity effects</strong> into <strong>selection</strong> and <strong>complementarity effects</strong>, are usually top-down. They start from the net difference in community-level yield from the expected community yield, based on monoculture performance, and then explain how this breaks down into the two main components, and how each of these components is calculated. It is a partitioning scheme after all, so this <em>whole-to-parts</em> perspective makes sense. That does not necessarily make it an easy way in. There is a higher cognitive load involved in unpacking complex concepts, relative to assembling them from simple parts. So I suspect that a bottom-up approach may be less demanding; we get to understand the fundamental quantities and what they represent, and only then do we figure out how they fit together.</p>
<p>Let’s try that.</p>
</section>
<section id="the-experiment" class="level2">
<h2 class="anchored" data-anchor-id="the-experiment">the experiment</h2>
<p>The standard design of a biodiversity &amp; ecosystem functioning experiment features monocultures of individual species and the same species grown in mixtures<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. The set up of the experiment is substitutive, in the sense that all experimental units start with the same amount of organisms. What this amount is, depends on the type of community examined; number of seeds for grassland communities, saplings for forest ones, cells for unicellular phytoplankton. So if monocultures are set up with 1000 cells per volume of water, four-species mixtures will have 250 cells per species. Also, all experimental units have the same amount of resources—more generally, they grow under the same conditions—which in the case of a field experiment is usually accomplished with a “common garden” design.</p>
<p>Single and multispecies communities are established, then harvested after a reasonable amount of time. The question is then, first, whether mixtures have a higher yield than monocultures and second, how that relates to individual species performance in mixtures relative to their monoculture.</p>
</section>
<section id="parts-to-whole" class="level2">
<h2 class="anchored" data-anchor-id="parts-to-whole">parts to whole</h2>
<p>In other words, for every species <span class="math inline">\(i\)</span> in every mixture community <span class="math inline">\(j\)</span>, we are interested in the yield of the species in the mixture <span class="math inline">\(Y_i^j\)</span> relative to its yield in the monoculture <span class="math inline">\(M_i\)</span>. The ratio of the two is called relative yield:</p>
<p><span class="math display">\[RY_i^j =\frac{Y_i^j}{M_i}\]</span></p>
<p>Now recall that, due to the substitutive design of the experiment, in a mixture of N species, species <span class="math inline">\(i\)</span> will start with 1/N of its monoculture amount. Therefore, 1/N is also the null expectation for the species’ relative yield, that is <em>relative to its monoculture yield not to the mixture’s total yield</em><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. So if the species’ yield when cultured alone is 40 biomass units, its expected yield when it is cultured with three other species <em>and therefore starts with a quarter of its monoculture starting amount</em>, would be <span class="math inline">\(\frac{1}{4} \cdot40\)</span> biomass units.</p>
<p>Therefore, the difference of the observed relative yield from the null expectation is:</p>
<p><span class="math display">\[\Delta RY_i^j = \frac{Y_i^j}{M_i} - \frac{1}{N^j}\]</span> <span class="math inline">\(\Delta RY_i^j\)</span> is going to be zero if a species’ performance in mixture <span class="math inline">\(j\)</span> is exactly what we would expect based on its monoculture performance. This would indicate that diversity <em>i.e.</em> growing in a mixture, has no influence on the performance of this particular species. If all species in all mixtures perform as expected based on their monocultures, then there are no discernible diversity effects, period.</p>
<p>Let us now consider deviations from that null expectation; a species’ yield in a mixture can be higher than the null expectation, in which case <span class="math inline">\(\Delta RY_i^j &gt; 0\)</span> or lower, so <span class="math inline">\(\Delta RY_i^j &lt; 0\)</span>. In practice, these are never going to be exactly zero because, even in the absence of diversity effects, there would be some variation in how much a species yields in each experimental unit. But a more ecologically interesting source of deviation is if some species over or underperform in the presence of other species. There will be some variation in species’ <span class="math inline">\(\Delta RY_i^js\)</span> in a given mixture; these may both positive and negative or be on one side of zero only. Species will also vary in their monoculture yield. The next thing we are going to calculate, is the covariance between species’ monoculture yield <span class="math inline">\(M_i\)</span> and their <span class="math inline">\(\Delta RY_i^j\)</span>: <span class="math display">\[\operatorname{cov}(\mathbf{M}^j, \boldsymbol{\Delta} \mathbf{RY}^j)\]</span> where <span class="math inline">\(\mathbf{M}^j\)</span> is the vector of monoculture yields for all species in mixture <span class="math inline">\(j\)</span> and <span class="math inline">\(\boldsymbol{\Delta} \mathbf{RY}^j\)</span> is the vector of their deviations from the expected yield. This covariance will be positive if the species with higher monoculture yield are also those with higher <span class="math inline">\(\Delta RY_i^js\)</span>, and negative if these species have lower <span class="math inline">\(\Delta RY_i^js\)</span>. It will be close to zero if monoculture yield tells us nothing about how different species deviate from the expected yield.</p>
<p>Let’s recap. Within a mixture, a species may yield more or less than what is expected based on its monoculture yield, indicating some influence of the presence of other species on its own productivity, or it may yield close to the null expectation, indicating a lack of such an influence. Then, the covariance between monoculture yields and deviations from the expected yield in a mixture can be positive if species that are productive alone also tend to fair better in a mixture, whether that means overperforming or simply underperforming less than other species do. The covariance will be negative if species that are productive in isolation do relatively worse than other species in terms of their deviation from the expected yield.</p>
<p>Covariance is calculated as: <span class="math display">\[\operatorname{cov}(\mathbf{M}^j, \boldsymbol{\Delta} \mathbf{RY}^j) = \frac{1}{N^j} \sum_{i=1}^{N^j} (M_i^j - \overline{M^j})(\Delta RY_i^j - \overline{\Delta RY^j})\]</span></p>
<p>Note that the sum here is divided by <span class="math inline">\(N\)</span> rather than <span class="math inline">\(N-1\)</span>, which would be the conventional small-sample bias correction applied for example by the base R <code>cov()</code> function. The <span class="math inline">\(N-1\)</span> version gives an unbiased covariance <em>estimator</em>. Instead here we <em>calculate</em> covariance for the entire “population” i.e.&nbsp;all the species in this particular experimental unit.</p>
<p>By its mathematical definition, covariance is a per species quantity. We can multiply it again by <span class="math inline">\(N^j\)</span>, the number of species that comprise the mixture, to get a community level quantity. This quantity is what <span class="citation" data-cites="loreau2001">Loreau and Hector (<a href="#ref-loreau2001" role="doc-biblioref">2001</a>)</span> defined as the <strong>selection effect</strong>: <span class="math display">\[SE^j = N^j \cdot \operatorname{cov}(\mathbf{M}^j, \boldsymbol{\Delta} \mathbf{RY}^j)\]</span></p>
<p>It expresses the extent to which community-level deviations from monoculture-based expectations are accounted for by a covariance—positive or negative—between species-level deviations and their monoculture performance.</p>
<p>Now let us consider what is the average relative yield of the species in a mixture community <span class="math inline">\(j\)</span>. If the average species in the mixture does better than expected by its monoculture, <span class="math inline">\(\overline{\Delta RY^{j}}\)</span> will be positive. It will be negative if it does worse, or close to zero if positive deviations tend to cancel out with negative ones. Now recall that <span class="math inline">\(RY_i^j\)</span> and <span class="math inline">\(\Delta RY_i^j\)</span> are proportional quantities. Similarly, <span class="math inline">\(\overline{\Delta RY^{j}}\)</span> gives us the average <em>proportional</em> deviation from the expected yield. <span class="math inline">\(\overline{M^j}\)</span> is the monoculture yield of the average species in community <span class="math inline">\(j\)</span>. By multiplying the two, <span class="math inline">\(\overline{\Delta RY^{j}} \cdot \overline{M^j}\)</span>, we get the average per-species gain or loss in yield due to diversity effects. The multiplication with <span class="math inline">\(\overline{M^j}\)</span> takes us from the proportional scale back to the raw yield scale. So if the monoculture yield of the average species is large, then a proportional change will lead to a large change in absolute terms. If the monoculture yield average is small, even large proportional changes will amount to a small change in yield. Multiplying again by <span class="math inline">\(N^j\)</span>, we get the community-level change in yield that can be attributed to an increase or decrease in average species-level performance and is what <span class="citation" data-cites="loreau2001">Loreau and Hector (<a href="#ref-loreau2001" role="doc-biblioref">2001</a>)</span> defined as the <strong>complementarity effect</strong>:</p>
<p><span class="math display">\[CE^j = N^j \cdot \overline{\Delta RY^{j}} \cdot \overline{M^j}\]</span></p>
<p>Together, the two terms give us the net difference in yield:</p>
<p><span class="math display">\[\Delta Y^j = N^j \cdot \operatorname{cov}(\mathbf{M}^j, \boldsymbol{\Delta} \mathbf{RY}^j) + N^j \cdot \overline{\Delta RY^{j}} \cdot \overline{M^j}\]</span></p>
<p><span class="citation" data-cites="loreau2001">Loreau and Hector (<a href="#ref-loreau2001" role="doc-biblioref">2001</a>)</span> call this the <strong>net biodiversity effect</strong> i.e.</p>
<p><span class="math display">\[NBE^j = SE^j + CE^j\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>loreau_hector <span class="ot">=</span> <span class="cf">function</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    M_i,                <span class="co"># vector of species yield in monoculture</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    Y_i                 <span class="co"># vector of species yield in mixture</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>       ) {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">=</span> <span class="fu">length</span>(M_i)       <span class="co"># number of species in the mixture</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  dRY <span class="ot">=</span> Y_i<span class="sc">/</span>M_i <span class="sc">-</span> <span class="dv">1</span><span class="sc">/</span>N   <span class="co"># deviation from expected relative yield of species i</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  M_bar <span class="ot">=</span> <span class="fu">mean</span>(M_i)     <span class="co"># average yield across the monocultures of constituent species</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  dRY_bar <span class="ot">=</span> <span class="fu">mean</span>(dRY)   <span class="co"># mean deviation</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  CE <span class="ot">=</span> N <span class="sc">*</span> dRY_bar <span class="sc">*</span> M_bar                    <span class="co"># complementarity effect</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  SE <span class="ot">=</span> <span class="fu">sum</span>((M_i <span class="sc">-</span> M_bar) <span class="sc">*</span> (dRY <span class="sc">-</span> dRY_bar))   <span class="co"># selection effect</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  NE <span class="ot">=</span> CE <span class="sc">+</span> SE                                <span class="co"># net effect</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(NE,CE,SE)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>



</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-loreau2001" class="csl-entry" role="listitem">
Loreau, Michel, and Andy Hector. 2001. <span>“Partitioning Selection and Complementarity in Biodiversity Experiments.”</span> <em>Nature</em> 412 (6842): 72–76. <a href="https://doi.org/10.1038/35083573">https://doi.org/10.1038/35083573</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Not all BEF experiments have monocultures of all the species that comprise the mixtures but that is a requirement of the Loreau &amp; Hector partitioning.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>This is a crucial aspect of the LH partitioning: we are always comparing species to <em>themselves</em> under two different scenarios, when grown alone vs when grown with other species. We are <em>not</em> comparing how species perform relative to other species. This has been a major source of confusion for me.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/amynang\.github\.io\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>